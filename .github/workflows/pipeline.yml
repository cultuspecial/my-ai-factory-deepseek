name: ðŸ­ AI Research Factory

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  run-factory:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½®PythonçŽ¯å¢ƒ
      - name: ðŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. å®‰è£…ç³»ç»Ÿå·¥å…· (jq, bc) å’ŒPythonä¾èµ–
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc  # å®‰è£…çœ‹æ¿è®¡ç®—éœ€è¦çš„å·¥å…·
          pip install -r requirements.txt

      # 4. æ‰§è¡Œæ ¸å¿ƒAIä»»åŠ¡
      - name: ðŸ¤– æ‰§è¡Œæ ¸å¿ƒä»»åŠ¡
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
        run: |
          echo "å¼€å§‹æŠ“å–è®ºæ–‡..."
          python crawler.py
          echo "å¼€å§‹æ€»ç»“è®ºæ–‡..."
          python summarize.py

      # 5. ä¿å­˜è¿è¡ŒåŽ†å²
      - name: ðŸ’¾ æäº¤åŽ†å²è®°å½•
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add run_history.jsonl ai_research_report.md
          git commit -m "chore: auto-update report and history [skip ci]" || echo "æ²¡æœ‰æ–°å˜æ›´ï¼Œæ— éœ€æäº¤ã€‚"
          git push

      # 6. ç”Ÿæˆè¿è¡Œçœ‹æ¿ï¼ˆSummaryï¼‰- ä¿®æ­£ç‰ˆ
      - name: ðŸ“ˆ ç”Ÿæˆè¿è¡Œçœ‹æ¿
        if: always()
        run: |
          echo "### ðŸ­ å·¥åŽ‚è¿è¡Œç®€æŠ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥åŽ†å²æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "run_history.jsonl" ]; then
            echo "**çŠ¶æ€**: ðŸŸ¡ ç­‰å¾…é¦–æ¬¡è¿è¡Œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„Pythonè„šæœ¬æ–‡ä»¶æ¥è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ï¼Œé¿å…YAMLå†…åµŒæ ¼å¼é—®é¢˜
          python3 -c "
          import json, os, sys
          try:
          with open('run_history.jsonl', 'r', encoding='utf-8') as f:
          lines = [json.loads(l.strip()) for l in f if l.strip()]
    
          if not lines:
          print('**çŠ¶æ€**: ðŸŸ¡ æš‚æ— æœ‰æ•ˆæ•°æ®')
          sys.exit(0)
    
          last_run = lines[-1]
          total_runs = len(lines)
          total_tokens = sum(r.get('total_tokens', 0) for r in lines)
          estimated_cost_cny = (total_tokens / 1_000_000) * 2.0  # å‡è®¾2å…ƒ/ç™¾ä¸‡tokens
    
          print(f'**æœ€è¿‘è¿è¡Œæ—¶é—´**: {last_run.get(\"timestamp\", \"N/A\")[:19]}')
          print(f'**ç´¯è®¡è¿è¡Œæ¬¡æ•°**: {total_runs}')
          print(f'**ç´¯è®¡Tokenæ¶ˆè€—**: {total_tokens}')
          print(f'**é¢„ä¼°æ€»æˆæœ¬**: Â¥{estimated_cost_cny:.4f}')
          status = last_run.get('status', 'UNKNOWN')
          if status == 'HEALTHY':
          status_text = 'ðŸŸ¢ å¥åº·'
          elif status == 'DEGRADED':
          status_text = 'ðŸŸ¡ é™çº§'
          else:
          status_text = 'ðŸ”´ å¤±è´¥'
          print(f'**ä¸Šæ¬¡çŠ¶æ€**: {status_text}')
          print('')
          print('> ðŸ’¡ æç¤ºï¼šå®Œæ•´æŠ¥å‘Šå·²ç”Ÿæˆ \`ai_research_report.md\`ï¼ŒåŽ†å²æ•°æ®è¯¦è§ \`run_history.jsonl\`ã€‚')
    
    except Exception as e:
          print(f'ç”Ÿæˆçœ‹æ¿æ—¶å‡ºé”™: {e}')
" >> $GITHUB_STEP_SUMMARY
